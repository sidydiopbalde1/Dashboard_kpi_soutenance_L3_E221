// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ===== TABLES EXISTANTES =====

model ProductionData {
  id              Int      @id @default(autoincrement())
  timestamp       DateTime @default(now())
  bottlesProduced Int
  targetRate      Int      @default(120)
  actualRate      Int
  defectCount     Int      @default(0)
  isRunning       Boolean  @default(true)
  shiftId         String
  temperature     Float?
  pressure        Float?
  
  @@index([timestamp])
  @@index([shiftId])
}

model Downtime {
  id          Int       @id @default(autoincrement())
  startTime   DateTime
  endTime     DateTime?
  duration    Int?
  reason      String
  category    String
  description String?
  operator    String?
  resolved    Boolean   @default(false)
  
  @@index([startTime])
  @@index([category])
}

model Alert {
  id          Int       @id @default(autoincrement())
  timestamp   DateTime  @default(now())
  type        String
  severity    String
  message     String
  threshold   Float?
  actualValue Float?
  isResolved  Boolean   @default(false)
  resolvedAt  DateTime?
  resolvedBy  String?
  
  @@index([timestamp, isResolved])
  @@index([severity])
}

model KPISnapshot {
  id              Int      @id @default(autoincrement())
  timestamp       DateTime @default(now())
  period          String
  trs             Float
  availability    Float
  performance     Float
  quality         Float
  totalProduced   Int
  totalDefects    Int
  totalDowntime   Int
  oee             Float?
  mtbf            Float?
  mttr            Float?
  shiftId         String?
  
  @@index([timestamp, period])
  @@index([shiftId])
}

model AlertThreshold {
  id          Int      @id @default(autoincrement())
  kpiType     String   @unique
  minValue    Float?
  maxValue    Float?
  severity    String
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([kpiType])
}

// ===== TABLES AJOUTÉES =====

// Gestion des équipements
model Equipment {
  id                String             @id @default(cuid())
  name              String
  location          String
  type              String             // 'production_line', 'compressor', 'quality_control'
  model             String?
  serialNumber      String?
  installationDate  DateTime?
  status            String             @default("running") // 'running', 'warning', 'error', 'maintenance'
  efficiency        Float              @default(100)
  lastMaintenance   DateTime?
  nextMaintenance   DateTime?
  isActive          Boolean            @default(true)
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  
  // Relations
  maintenanceTasks  MaintenanceTask[]
  energyConsumption EnergyConsumption[]
  
  @@index([status])
  @@index([type])
}

// Maintenance
model MaintenanceTask {
  id                String    @id @default(cuid())
  equipmentId       String
  type              String    // 'preventive', 'corrective', 'emergency'
  status            String    @default("planned") // 'planned', 'in_progress', 'completed', 'cancelled'
  priority          String    @default("medium") // 'low', 'medium', 'high', 'urgent'
  title             String
  description       String
  assignedTo        String?
  scheduledDate     DateTime
  startedAt         DateTime?
  completedAt       DateTime?
  estimatedDuration Int       // en minutes
  actualDuration    Int?      // en minutes
  cost              Float?
  spareParts        String[]  // JSON array des pièces utilisées
  comments          String?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  
  // Relations
  equipment         Equipment @relation(fields: [equipmentId], references: [id])
  
  @@index([status])
  @@index([type])
  @@index([scheduledDate])
}

// Qualité détaillée
model QualityControl {
  id              String   @id @default(cuid())
  timestamp       DateTime @default(now())
  lotNumber       String
  productType     String
  defectType      String?
  severity        String?  // 'minor', 'major', 'critical'
  quantity        Int
  totalProduced   Int
  operator        String
  line            String
  shift           String
  correctedAction String?
  status          String   @default("open") // 'open', 'investigating', 'corrected', 'closed'
  inspector       String?
  comments        String?
  
  @@index([timestamp])
  @@index([status])
  @@index([severity])
}

// Énergie
model EnergyConsumption {
  id                String    @id @default(cuid())
  timestamp         DateTime  @default(now())
  equipmentId       String?
  consumption       Float     // kW
  cost              Float?    // €
  efficiency        Float?    // %
  carbonFootprint   Float?    // kg CO2
  peakDemand        Float?    // kW
  tariffPeriod      String?   // 'peak', 'off_peak'
  renewable         Boolean   @default(false)
  
  // Relations
  equipment         Equipment? @relation(fields: [equipmentId], references: [id])
  
  @@index([timestamp])
  @@index([equipmentId])
}

// Équipes et personnel
model Employee {
  id              String   @id @default(cuid())
  employeeNumber  String   @unique
  firstName       String
  lastName        String
  role            String
  shift           String   // 'MATIN', 'APRES_MIDI', 'NUIT'
  workstation     String
  skills          String[] // JSON array
  certifications  String[] // JSON array
  hireDate        DateTime
  isActive        Boolean  @default(true)
  performanceScore Float?
  efficiencyScore Float?
  qualityScore    Float?
  safetyScore     Float?
  lastTraining    DateTime?
  nextTraining    DateTime?
  experience      Int?     // années
  
  // Relations
  shifts          ShiftRecord[]
  trainings       Training[]
  
  @@index([shift])
  @@index([role])
}

// Enregistrement des shifts
model ShiftRecord {
  id           String    @id @default(cuid())
  employeeId   String
  date         DateTime
  shift        String
  startTime    DateTime
  endTime      DateTime?
  status       String    @default("present") // 'present', 'absent', 'break', 'training'
  productivity Float?
  comments     String?
  
  // Relations
  employee     Employee  @relation(fields: [employeeId], references: [id])
  
  @@index([date])
  @@index([shift])
}

// Formation
model Training {
  id            String    @id @default(cuid())
  title         String
  type          String    // 'safety', 'technical', 'quality', 'leadership'
  description   String?
  duration      Int       // heures
  instructor    String?
  status        String    @default("planned") // 'planned', 'in_progress', 'completed', 'cancelled'
  scheduledDate DateTime
  completedDate DateTime?
  
  // Relations
  participants  Employee[]
  
  @@index([type])
  @@index([status])
}

// Sécurité
model SafetyIncident {
  id                String     @id @default(cuid())
  timestamp         DateTime   @default(now())
  type              String     // 'accident', 'near_miss', 'unsafe_condition', 'non_compliance'
  severity          String     // 'low', 'medium', 'high', 'critical'
  title             String
  description       String
  location          String
  reportedBy        String
  involvedPersons   Int        @default(0)
  injuryType        String?
  bodyPart          String?
  rootCause         String?
  correctiveActions String[]   // JSON array
  status            String     @default("open") // 'open', 'investigating', 'corrected', 'closed'
  daysLost          Int?
  cost              Float?
  investigator      String?
  closedAt          DateTime?
  
  @@index([timestamp])
  @@index([type])
  @@index([severity])
  @@index([status])
}

// Ordres de production
model ProductionOrder {
  id               String    @id @default(cuid())
  orderNumber      String    @unique
  productType      String
  quantity         Int
  produced         Int       @default(0)
  targetRate       Int
  actualRate       Int?
  startTime        DateTime?
  endTime          DateTime?
  estimatedEndTime DateTime
  status           String    @default("waiting") // 'waiting', 'running', 'paused', 'completed', 'cancelled'
  priority         String    @default("medium") // 'low', 'medium', 'high', 'urgent'
  line             String
  operator         String?
  shift            String?
  customer         String?
  setupTime        Int?      // minutes
  downtime         Int       @default(0) // minutes
  comments         String?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
  
  @@index([status])
  @@index([priority])
  @@index([line])
}

// Configuration système
model SystemConfig {
  id          String   @id @default(cuid())
  category    String   // 'thresholds', 'targets', 'alerts'
  key         String
  value       String
  dataType    String   // 'string', 'number', 'boolean', 'json'
  description String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@unique([category, key])
  @@index([category])
}

// Rapports générés
model Report {
  id          String   @id @default(cuid())
  title       String
  type        String   // 'production', 'quality', 'maintenance', 'safety', 'energy'
  format      String   // 'pdf', 'excel', 'csv'
  period      String
  parameters  String   // JSON des paramètres utilisés
  filePath    String?
  fileSize    Int?
  status      String   @default("generating") // 'generating', 'completed', 'failed'
  error       String?
  generatedBy String
  createdAt   DateTime @default(now())
  
  @@index([type])
  @@index([status])
  @@index([createdAt])
}

// Audit trail
model AuditLog {
  id         String   @id @default(cuid())
  timestamp  DateTime @default(now())
  userId     String
  action     String   // 'create', 'update', 'delete', 'login', 'logout'
  entity     String   // table name
  entityId   String?
  oldValues  String?  // JSON
  newValues  String?  // JSON
  ipAddress  String?
  userAgent  String?
  
  @@index([timestamp])
  @@index([userId])
  @@index([entity])
}